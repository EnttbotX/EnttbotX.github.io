<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cancelación activa (inversión) - Demo</title>
  <style>
    :root{font-family:Inter,system-ui,Arial;margin:0}
    body{display:flex;align-items:center;justify-content:center;height:100vh;background:#0f1720;color:#e6eef8}
    .card{width:720px;padding:24px;border-radius:12px;background:linear-gradient(180deg,#0b1220, #0f1720);box-shadow:0 6px 24px rgba(0,0,0,.6)}
    h1{margin:0 0 12px;font-size:20px}
    p{margin:6px 0 14px;color:#b9c6d9}
    .row{display:flex;gap:8px;align-items:center}
    button{padding:10px 14px;border-radius:8px;border:0;background:#1f6feb;color:white;cursor:pointer}
    button.warn{background:#e05353}
    label{font-size:13px;color:#9fb0d1}
    input[type=range]{width:220px}
    small{color:#a3b4cc}
    .status{margin-top:12px;color:#9fb0d1}
    audio{display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>Cancelación activa (inversión de ambiente)</h1>
    <p>Demo que captura micrófono, lo invierte (ganancia -1) y lo reproduce por la salida de audio. Usá auriculares para evitar realimentación.</p>

    <div class="row" style="margin-bottom:8px">
      <button id="startBtn">Iniciar</button>
      <button id="stopBtn" class="warn" disabled>Detener</button>
      <label style="margin-left:8px">Ganancia (fuerza): <span id="gainLabel">1.0</span></label>
    </div>
    <div class="row" style="margin:10px 0">
      <input id="gainSlider" type="range" min="0" max="2" step="0.01" value="1">
      <label style="margin-left:8px"><input id="lowLatency" type="checkbox" checked> Intentar baja latencia</label>
    </div>

    <div class="status" id="status">Estado: detenido</div>
    <small>Nota: esto es una aproximación técnica. Para cancelación real y segura necesitás auriculares cerrados y baja latencia hardware.</small>

    <audio id="out" autoplay playsinline></audio>
  </div>

  <script>
    let ctx, micStream, srcNode, invertGain, dest, outAudio;
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const gainSlider = document.getElementById('gainSlider');
    const gainLabel = document.getElementById('gainLabel');
    const lowLatency = document.getElementById('lowLatency');
    outAudio = document.getElementById('out');

    gainSlider.addEventListener('input', ()=>{
      gainLabel.textContent = Number(gainSlider.value).toFixed(2);
      if(invertGain) invertGain.gain.value = -Number(gainSlider.value);
    });

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);

    async function start(){
      if(ctx && ctx.state !== 'closed') return;
      status('pidiendo permiso...');
      try{
        const constraints = { audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: false } };
        micStream = await navigator.mediaDevices.getUserMedia(constraints);

        ctx = new (window.AudioContext || window.webkitAudioContext)({latencyHint: lowLatency.checked ? 'interactive' : 'playback'});
        srcNode = ctx.createMediaStreamSource(micStream);

        invertGain = ctx.createGain();
        invertGain.gain.value = -Number(gainSlider.value); // invertir señal multiplicando por -1

        dest = ctx.createMediaStreamDestination();

        // source -> invertGain -> destination (stream reproducible en audio element)
        srcNode.connect(invertGain);
        invertGain.connect(dest);

        // reproducir por elemento audio para poder elegir sink (si está disponible)
        outAudio.srcObject = dest.stream;
        await outAudio.play().catch(()=>{});

        // intentar mandar la salida a un dispositivo de audio específico (auriculares) si el navegador lo permite
        if(typeof outAudio.setSinkId === 'function'){
          try{
            const devices = await navigator.mediaDevices.enumerateDevices();
            const audioOut = devices.find(d=>d.kind==='audiooutput' && /headphone|headset|earbud|audio/i.test(d.label.toLowerCase())) || devices.find(d=>d.kind==='audiooutput');
            if(audioOut) await outAudio.setSinkId(audioOut.deviceId);
          }catch(e){/* no crítico */}
        }

        startBtn.disabled = true; stopBtn.disabled = false;
        status('activo — probá con auriculares cerrados. Si escuchás realimentación, bajá volumen o poné auriculares.');
      }catch(err){
        console.error(err);
        status('error: '+(err.message||err));
        cleanup();
      }
    }

    function stop(){
      if(micStream){
        micStream.getTracks().forEach(t=>t.stop());
        micStream = null;
      }
      if(outAudio){outAudio.pause(); outAudio.srcObject = null}
      if(ctx){ ctx.close(); ctx = null }
      startBtn.disabled = false; stopBtn.disabled = true;
      status('detenido');
    }

    function status(text){ statusEl.textContent = 'Estado: '+text }

    function cleanup(){
      try{ if(micStream) micStream.getTracks().forEach(t=>t.stop()) }catch(e){}
      try{ if(ctx) ctx.close() }catch(e){}
      startBtn.disabled = false; stopBtn.disabled = true;
    }

    // seguridad: cuando la pestaña pierde foco o antes de cerrar, detener para evitar mic abierto
    window.addEventListener('pagehide', stop);
    window.addEventListener('unload', stop);
  </script>
</body>
</html>
